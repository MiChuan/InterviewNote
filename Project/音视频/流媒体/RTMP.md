# 网络流媒体协议——RTMP

> 流媒体协议常用实时信息传输协议（Real-Time Messaging Protocol，RTMP）和 HLS 协议。RTMP 为应用层协议，由 TCP 提供传输层的连接和传输服务，默认端口为1935。

## RTMP URL

```http
rtmp://host:port/app/steam
```

- `rtmp∶` 表示该URL必须以RTMP进行解析。
- `host, port` 分别表示主机地址和端口地址，主机以域名或 IP 地址的形式表示。如果RTMP使用了默认的1935端口，则URL中的端口号可省略。
- `app, stream` 分别表示当前音视频流所属的应用命名和流 ID，应用命名和流 ID 可以作为 RTMP 服务器区别不同用户的多路流的标识。

## RTMP 分块与块流

每条信息在传输之前都先被分割为若干数据分块（Chunk）。

### RTMP 握手流程

RTMP 在连接之前需要执行六次握手，即客户端和服务端分别向对方发送三次信息分块：客户端向服务端发送 C0、C1 和 C2 三个信息分块，服务端向客户端发送 S1、S2 和 S3 三个信息分块。

这6个信息分块的发送顺序如下：

- 客户端向服务端发送 C0 和 C1。

- 服务端在收到 C0 后，向客户端发送 S0 和 S1。

- 客户端在收到 S1 后，向服务端发送 C2。

- 服务端在收到 C1 后，向客户端发送 S2。

- 客户端在收到 S2 后，可以向服务端发送后续其他数据。

- 服务端在收到 C2 后，可以向客户端发送后续其他数据。

在 RTMP 的握手过程中，从开始到连接完成可分为四种状态。

- 未初始化（Uninitialized）：客户端与服务端沟通协议版本。
- 版本已发送（Version Sent）：客户端和服务端对协议版本已达成一致，再通过 C0/C1 和 S0/S1 确认二者信息收发渠道是否畅通。
- 确认信息已发送（Ack Sent）：客户端和服务端分别等待接收 S2 和 C2。
- 握手完成（HandshakeDone）：客户端和服务端分别接收 S2 和 C2，连接建立完成，可以进行后续信息的收发。

### RTMP 握手信息格式

C0和S0格式：C0和S0包含一个二进制数据，其值表示服务器指定的RTMP版本，当前的RTMP版本为3。

C1和S1格式：C1和S1的信息总长度为1536Byte，包括以下3个主要字段。

- 时间戳：长度为4 Byte，作为发送端后续信息的时间戳起始值。
- 零字节：长度为4 Byte，所有值必须为0。
- 随机数据：长度为1528 Byte，内容为随机数据，作为参加握手的连接方的区别信息。

C2和S2格式：C1和S1的信息总长度为1536Byte，主要格式与C1或S1类似，主要区别在于原本零字节的位置保存了先前发送给对方信息的时间戳。

- 时间戳：长度为4 Byte，包含本信息所响应的对方发送信息的时间戳，如对C2则表示S1的时间戳，对S2则表示C1的时间戳。
- 时间戳2：先前发送并由对方接收的时间戳，即C1或S1。
- 随机数据：长度为4 Byte，包含本信息所响应的对方发送信息的随机数据，如对C2则表示S1的随机数据，对S2则表示C1的随机数据。

### RTMP 分块格式

RTMP分块的主要思路是将大块的上层协议的信息分割为小块的数据，其优势如下。

- 将数据分割为小块传输可有效提升数据传输效率，如可以避免大块的低优先级数据长时间占用信道，导致小块的高优先级数据被阻塞。
- 可以将原本必须由信息负载传输的信息压缩保存于分块头中，降低了传输成本。

每个RTMP分块内的数据按照顺序可以分为以下四部分。

1. 分块基本头（Chunk Basic Header）：占1～3 Byte，主要包含分块流ID和分块类型。分块流ID决定了结构的长度，分块类型决定了后续的分块信息头的结构。
2. 分块信息头（Chunk Message Header）：占0、3、7或11 Byte，表示该分块所属的RTMP信息的数据，其长度由分块基本头中的分块类型决定。
3. 扩展时间戳（Extended Timestamp）：占0或4 Byte，当普通时间戳字段值为0xFFFFFF时，是必须字段；当普通时间戳字段为其他值时，则不进行传输。
4. 分块数据（Chunk Data）：当前分块所承载的实际数据。